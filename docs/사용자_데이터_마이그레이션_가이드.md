# 사용자 데이터 마이그레이션 가이드

## 개요
전화번호 기반 로그인 시스템을 이메일 기반 로그인 시스템으로 변경하면서 기존 사용자들의 데이터를 마이그레이션하는 방안입니다.

## 현재 상황
- **기존 시스템**: 전화번호를 `{전화번호}@engquiz.local` 형식으로 변환하여 Firebase Auth 사용
- **새 시스템**: 실제 이메일 주소를 Firebase Auth의 이메일로 사용

## 마이그레이션 방안

### 방안 1: 점진적 마이그레이션 (권장)

#### 1단계: 기존 사용자 식별
```javascript
// Firebase Console에서 실행할 수 있는 쿼리
// 전화번호 기반 계정 찾기
const usersRef = collection(db, 'users');
const q = query(usersRef, where('email', '==', '전화번호@engquiz.local'));
```

#### 2단계: 사용자에게 이메일 주소 요청
- 로그인 시 "이메일 주소를 등록해주세요" 모달 표시
- 기존 사용자가 실제 이메일 주소를 입력하도록 안내

#### 3단계: 계정 정보 업데이트
```javascript
// 사용자가 이메일을 입력하면
// 1. Firebase Auth에서 새 이메일로 계정 생성
// 2. 기존 Firestore 데이터를 새 계정으로 이전
// 3. 기존 계정 삭제
```

### 방안 2: 일괄 마이그레이션

#### 관리자 도구 생성
```javascript
// functions/migrateUsers.js
exports.migrateUsers = functions.https.onCall(async (data, context) => {
  // 관리자 권한 확인
  if (context.auth?.token?.role !== 'admin') {
    throw new functions.https.HttpsError('permission-denied', '관리자 권한이 필요합니다.');
  }

  // 모든 사용자 조회
  const usersSnapshot = await admin.firestore().collection('users').get();
  
  for (const userDoc of usersSnapshot.docs) {
    const userData = userDoc.data();
    
    // 전화번호 기반 계정인지 확인
    if (userData.email && userData.email.includes('@engquiz.local')) {
      // 이메일 주소가 있는 경우에만 마이그레이션
      if (userData.actualEmail) {
        await migrateUserAccount(userDoc.id, userData);
      }
    }
  }
});
```

## 구현 단계

### 1단계: 마이그레이션 UI 추가

#### 로그인 시 마이그레이션 안내
```typescript
// src/components/auth/MigrationModal.tsx
const MigrationModal = ({ user, onComplete }) => {
  const [email, setEmail] = useState('');
  
  const handleSubmit = async () => {
    // 이메일 주소 업데이트 로직
    await updateUserEmail(user.uid, email);
    onComplete();
  };
  
  return (
    <div className="migration-modal">
      <h3>이메일 주소 등록</h3>
      <p>서비스 개선을 위해 이메일 주소를 등록해주세요.</p>
      <input 
        type="email" 
        value={email}
        onChange={(e) => setEmail(e.target.value)}
        placeholder="이메일을 입력하세요"
      />
      <button onClick={handleSubmit}>등록</button>
    </div>
  );
};
```

### 2단계: 마이그레이션 함수 구현

#### 사용자 계정 마이그레이션
```typescript
// src/services/migrationService.ts
export const migrateUserAccount = async (oldUid: string, newEmail: string) => {
  try {
    // 1. 기존 사용자 데이터 가져오기
    const userData = await getCurrentUserData(oldUid);
    
    // 2. 새 이메일로 Firebase Auth 계정 생성
    const newUserCredential = await createUserWithEmailAndPassword(
      auth, 
      newEmail, 
      generateTemporaryPassword()
    );
    
    // 3. Firestore 데이터를 새 계정으로 이전
    await setDoc(doc(db, 'users', newUserCredential.user.uid), {
      ...userData,
      email: newEmail,
      migratedFrom: oldUid,
      migratedAt: new Date().toISOString()
    });
    
    // 4. 기존 계정 삭제
    await deleteUser(oldUid);
    
    return newUserCredential.user;
  } catch (error) {
    console.error('계정 마이그레이션 오류:', error);
    throw error;
  }
};
```

### 3단계: 관리자 마이그레이션 도구

#### 관리자 페이지에 마이그레이션 섹션 추가
```typescript
// src/components/admin/MigrationTool.tsx
const MigrationTool = () => {
  const [migrationStatus, setMigrationStatus] = useState('idle');
  const [usersToMigrate, setUsersToMigrate] = useState([]);
  
  const checkMigrationStatus = async () => {
    // 마이그레이션이 필요한 사용자 조회
    const users = await getUsersNeedingMigration();
    setUsersToMigrate(users);
  };
  
  const startMigration = async () => {
    setMigrationStatus('migrating');
    try {
      await migrateAllUsers();
      setMigrationStatus('completed');
    } catch (error) {
      setMigrationStatus('error');
    }
  };
  
  return (
    <div className="migration-tool">
      <h3>사용자 데이터 마이그레이션</h3>
      <button onClick={checkMigrationStatus}>마이그레이션 상태 확인</button>
      <button onClick={startMigration} disabled={migrationStatus === 'migrating'}>
        마이그레이션 시작
      </button>
    </div>
  );
};
```

## 주의사항

### 1. 데이터 백업
- 마이그레이션 전에 모든 사용자 데이터를 백업
- Firebase Console에서 Firestore 데이터 내보내기

### 2. 점진적 적용
- 모든 사용자를 한 번에 마이그레이션하지 말고 단계적으로 진행
- 테스트 사용자로 먼저 검증

### 3. 사용자 안내
- 마이그레이션 과정을 사용자에게 명확히 안내
- 이메일 주소 등록의 필요성 설명

### 4. 롤백 계획
- 문제 발생 시 이전 상태로 되돌릴 수 있는 계획 수립
- 백업 데이터를 이용한 복구 절차 준비

## 실행 순서

1. **백업 생성**: 현재 사용자 데이터 백업
2. **테스트 환경에서 검증**: 소수의 테스트 사용자로 마이그레이션 테스트
3. **점진적 적용**: 사용자 로그인 시 이메일 주소 등록 요청
4. **일괄 마이그레이션**: 이메일 주소가 등록된 사용자들을 일괄 마이그레이션
5. **정리 작업**: 마이그레이션 완료 후 기존 계정 정리

## 모니터링

- 마이그레이션 진행 상황 추적
- 실패한 마이그레이션 케이스 모니터링
- 사용자 피드백 수집 및 대응
